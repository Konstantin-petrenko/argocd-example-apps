apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollout-ref-deployment-guestbook
  annotations:
    # notifications.argoproj.io/subscribe.on-rollout-completed.slack: argo-notifications
    # notifications.argoproj.io/subscribe.on-rollout-step-completed.slack: argo-notifications
    # notifications.argoproj.io/subscribe.on-rollout-updated.slack: argo-notifications
    # notifications.argoproj.io/subscribe.on-scaling-replica-set.slack: argo-notifications
    # notifications.argoproj.io/subscribe.on-purple.telegram: argo-notifications-test
spec:
  # replicas: 5
  # progressDeadlineAbort: true
  progressDeadlineSeconds: 120
  minReadySeconds: 10
  workloadRef:
    apiVersion: apps/v1
    kind: Deployment
    name: guestbook-ui
  # namespace: argocd
  revisionHistoryLimit: 3
  strategy:
    canary:
      steps:
        - setWeight: 20
        - pause: {duration: 20s}
      # analysis:
      #   templates:
      #   # - templateName: random-fail
      #   - templateName: pass
# ---
# apiVersion: argoproj.io/v1alpha1
# kind: AnalysisTemplate
# metadata:
#   name: argo-combined-app
# spec:
#   args:
#   - name: service-name
#   metrics:
#   - name: success-rate
#     interval: 10s
#     successCondition: result[0] >= 0.8
#     failureCondition: result[0] < 0.8
#     failureLimit: 3
#     provider:
#       prometheus:
#         address: http://prometheus-server.monitoring
#         query: |
#           sum(irate(
#             istio_requests_total{
#               reporter="source",
#               destination_service=~"{{args.service-name}}",
#               response_code=~"2.*"
#             }[2m]
#           )) / sum(irate(
#             istio_requests_total{
#               reporter="source",
#               destination_service=~"{{args.service-name}}"
#             }[2m]
#           ))
